name: Snowflake Schema Change Workflow

on:
  push:
    branches:
      - main
      - 'deploy/*'

jobs:
  schemachange-deploy:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the repository
    - name: Checkout Repository
      uses: actions/checkout@v3

    # Step 2: Set up Python environment
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # Step 3: Install schemachange
    - name: Install schemachange
      run: |
        python -m pip install --upgrade pip
        pip install schemachange

    # Step 4: Run schemachange for migration
    - name: Run schemachange
      env:
        SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
        SF_USER: ${{ secrets.SF_USER }}
        SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
        SF_DATABASE: ${{ secrets.SF_DATABASE }}
        SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
        SF_ROLE: ${{ secrets.SF_ROLE }}
      run: |
        schemachange \
          --snowflake-account $SF_ACCOUNT \
          --snowflake-user $SF_USER \
          --snowflake-password $SF_PASSWORD \
          --snowflake-role $SF_ROLE \
          --snowflake-warehouse $SF_WAREHOUSE \
          --snowflake-database $SF_DATABASE \
          --change-history-table CHANGE_HISTORY \
          --root-folder migrations \
          --verbose
